<div data-role="collapsible" id="<?= $block->getData('apm_id')?>" class="cko-apm <?= $block->getData('apm_id')?>" tabindex="<?= $block->getData('tabIndex')?>">
    <div data-role="trigger">
		<span class="bg-<?= $block->getData('apm_id')?> bg-apm"><?= $block->getData('apm_id')?></span>
        <span><?= $block->getData('apm_id')?></span>
    </div>
</div>
<div data-role="content" class="apm-content <?= $block->getData('apm_id')?>">
    <form id="cko-apm-form-<?= $block->getData('apm_id')?>">
        <input type="hidden" name="source" value="<?= $block->getData('apm_id')?>">
        <input type="hidden" name="task" value="mandate">
    </form>
    <div id="klarna_nav"></div>
    <div id="klarna_container" align="center"></div>

    <script type="text/javascript">

        /**
         * Klarna controller
         */
        require(['jquery', 'domReady!'], function ($) {

            // Prepare the form id
            var klarnaForm = $('#' + 'cko-apm-form-<?= $block->getData('apm_id')?>');

            /**
             * Wait for klarna to be ready
             */
            window.klarnaAsyncCallback = function () {


                $.ajax({
                    type: 'POST',
                    url: '<?= $block->getUrl('checkout_com/apm/displayklarna')?>',
                    data: { source: 'klarna',
                            task: 'mandate'},

                    success: function (data) {

                        //klarnaForm.html(data.html);


                        var methods = [];

                        data.source.payment_method_categories.forEach(function(el, index) {

                            //$('#klarna_nav').prepend('<img id="' + el.identifier + '" src="' + el.asset_urls.standard + '" />');
                            methods.push(el.identifier);

                        })


                        try {

                            Klarna.Payments.init({client_token: data.source.client_token}); // Initialize Klarna

                            Klarna.Payments.load({  container:                  "#klarna_container",
                                                    payment_method_categories:  methods, // @todo: update this with the data from the response
                                                    instance_id:                "klarna-payments-instance"},
                                {
                                    purchase_country:   data.purchase_country,
                                    purchase_currency:  data.currency,
                                    locale:             data.locale,
                                    order_amount:       data.amount,
                                    order_tax_amount:   data.tax_amount,
                                    order_lines:        data.products
                                },
                                function (response) {
                                    console.log('success', response);
                                }
                            );

                        } catch (e) {

                            //@todo: handle error
                            console.log('error', e);

                        }

                    },
                    error: function (request, status, error) {
                        //@todo: handle error
                        console.log(error);
                    }
                });

            };

        });
    </script>
	<script src="https://x.klarnacdn.net/kp/lib/v1/api.js" async></script>
</div>
